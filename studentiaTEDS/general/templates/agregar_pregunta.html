{% extends 'base.html' %}
{% load static %}

{% block content %}
<br><br>
<div class="container py-5">
    <h2>Agregar Pregunta a: {{ examen.titulo }}</h2>

    <!-- Mostrar mensajes -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Campo tipo -->
        <div class="form-group">
            {{ pregunta_form.tipo.label_tag }}
            {{ pregunta_form.tipo }}
            {% if pregunta_form.tipo.errors %}
                <div class="invalid-feedback d-block">
                    {{ pregunta_form.tipo.errors }}
                </div>
            {% endif %}
        </div>

        <!-- Campo texto -->
        <div class="form-group">
            {{ pregunta_form.texto.label_tag }}
            {{ pregunta_form.texto }}
            {% if pregunta_form.texto.errors %}
                <div class="invalid-feedback d-block">
                    {{ pregunta_form.texto.errors }}
                </div>
            {% endif %}
            <small class="form-text text-muted">Ingrese el enunciado de la pregunta</small>
        </div>

        <!-- Opciones para opción múltiple -->
        <div id="opciones-multiples" class="mb-4" style="display:none;">
            <h4>Opciones (mínimo 2, máximo 5):</h4>
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="mb-3 border p-3 rounded bg-light">
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    
                    <div class="form-group">
                        {{ form.texto.label_tag }}
                        {{ form.texto }}
                        {% if form.texto.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.texto.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group form-check">
                        {{ form.es_correcta }}
                        {{ form.es_correcta.label_tag }}
                        {% if form.es_correcta.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.es_correcta.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group form-check">
                        {{ form.DELETE }}
                        {{ form.DELETE.label_tag }}
                    </div>
                </div>
            {% endfor %}
            <div class="alert alert-info">
                <strong>Nota:</strong> Marque al menos una opción como correcta y complete mínimo 2 opciones.
            </div>
        </div>

        <!-- Respuesta Verdadero/Falso -->
        <div id="opcion-vf" class="mb-4" style="display:none;">
            <h4>Respuesta Verdadero/Falso</h4>
            <div class="form-group">
                {% for radio in vf_form.respuesta %}
                <div class="form-check">
                    {{ radio.tag }}
                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                        {{ radio.choice_label }}
                    </label>
                </div>
                {% endfor %}
                {% if vf_form.respuesta.errors %}
                    <div class="invalid-feedback d-block">
                        {{ vf_form.respuesta.errors }}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary">Guardar Pregunta</button>
            <a href="{% url 'listar_preguntas' examen.slug %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tipoSelect = document.querySelector('select[name="tipo"]');
    const opcionesMultiples = document.getElementById('opciones-multiples');
    const opcionVF = document.getElementById('opcion-vf');

    function actualizarVista() {
        const tipo = tipoSelect.value;

        opcionesMultiples.style.display = 'none';
        opcionVF.style.display = 'none';

        if (tipo === 'opcion_multiple') {
            opcionesMultiples.style.display = 'block';
        } else if (tipo === 'verdadero_falso') {
            opcionVF.style.display = 'block';
        }
    }

    // Mostrar/ocultar secciones según tipo seleccionado
    tipoSelect.addEventListener('change', actualizarVista);
    
    // Ejecutar al cargar la página por si hay errores y se recarga el form
    actualizarVista();
    
    // Si hay errores, mostrar el tipo que estaba seleccionado
    {% if pregunta_form.errors or formset.errors or vf_form.errors %}
        const tipoError = "{{ request.POST.tipo }}";
        if (tipoError) {
            tipoSelect.value = tipoError;
            actualizarVista();
        }
    {% endif %}
});
</script>
{% endblock %}